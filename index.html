<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze Chat Demo (PKCE)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            margin-bottom: 30px;
        }
        #chat-container {
            display: none; /* 初始隐藏对话框 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5); /* 半透明背景 */
        }
        #chat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
         #messages {
             text-align: left; /* 确保消息内容靠左对齐 */
        }
        @media (max-width: 768px) {
          #chat-box {
            max-width: 95%;
            max-height: 95%;
            }
        }
    </style>
</head>
<body>
    <h1>Coze Chat Demo (PKCE)</h1>
    <button id="startChatButton">Start Chat with Bot</button>
    <div id="chat-container">
        <div id="chat-box">
            <div id="messages"></div>
            <textarea id="messageInput" placeholder="Type your message"></textarea>
            <button id="sendMessageButton">Send</button>
        </div>
    </div>

    <script>
        const clientId = "你的客户端ID"; //  请替换为你的客户端ID
        const redirectUri = "你的回调地址"; //  请替换为你的回调地址，必须与你在Coze平台配置的一致。
        const authorizationEndpoint = "https://www.coze.com/api/permission/oauth2/authorize";
        const tokenEndpoint = "https://api.coze.com/oauth/access_token";
        const botId = "你的机器人ID"; //  请替换为你的机器人ID
        const apiEndpoint = "https://api.coze.com/v1/bot/chat";


        const chatContainer = document.getElementById("chat-container");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendMessageButton = document.getElementById("sendMessageButton");
         const startChatButton = document.getElementById("startChatButton");

        let accessToken = null;
        let codeVerifier = null;

        startChatButton.addEventListener("click", startChat);
         sendMessageButton.addEventListener("click", sendMessage);


          function generateCodeVerifier() {
             let randomString = '';
             const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
             for (let i = 0; i < 43; i++) { // PKCE 建议 43-128 位
               randomString += possible.charAt(Math.floor(Math.random() * possible.length));
             }
             return randomString;
         }

         async function generateCodeChallenge(codeVerifier) {
             const encoder = new TextEncoder();
             const data = encoder.encode(codeVerifier);
             const digest = await crypto.subtle.digest('SHA-256', data);
             const base64String = btoa(String.fromCharCode(...new Uint8Array(digest)));
             return base64String.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
         }

       async function startChat() {
            codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
           const state = Math.random().toString(36).substring(2,15)
            const params = new URLSearchParams({
                client_id: clientId,
                response_type: "code",
                redirect_uri: redirectUri,
                 state: state,
                code_challenge: codeChallenge,
                code_challenge_method: "S256",
            });

            window.location.href = `${authorizationEndpoint}?${params.toString()}`;

        }


         // 从 URL 中提取授权码
        function getCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");
            console.log("Extracted code:", code); // 添加这一行
            return code;
        }

        async function fetchAccessToken(code) {
            const params = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                client_id: clientId,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier
            });
           console.log("fetchAccessToken request params:", params.toString()); // 添加此行
            try {
                const response = await fetch(tokenEndpoint, {
                    method: "POST",
                     headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString(),
                });
                 const data = await response.json();
                  console.log("fetchAccessToken response:", data);  // 添加此行
                 if (response.ok) {
                     accessToken = data.access_token;
                     chatContainer.style.display = "flex";
                     console.log("Access token:", accessToken);  // 添加此行
                } else {
                     console.error("Failed to fetch access token:", data);
                 }

            } catch (error) {
                console.error("Error fetching access token:", error);
            }
          }


          function checkAndFetchToken() {
             const code = getCodeFromUrl();
            if(code) {
                fetchAccessToken(code);
                 window.history.replaceState({}, document.title, window.location.pathname);
            }

         }
        document.addEventListener('DOMContentLoaded', function() {
            checkAndFetchToken();
         });



        async function sendMessage() {
             if (!accessToken) {
              console.error("Access token not available");
             return;
          }

            const message = messageInput.value.trim();
            if (!message) return;
             // 创建消息元素并添加到消息容器
             const userMessageDiv = document.createElement('div');
             userMessageDiv.textContent = 'You: ' + message;
             messagesDiv.appendChild(userMessageDiv);

            messageInput.value = "";

             try{
                 const response = await fetch(apiEndpoint, {
                     method: "POST",
                     headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                     },
                    body: JSON.stringify({
                        "bot_id": botId,
                        "inputs": [
                           {
                             "query": message,
                             "type": "text"
                            }
                         ]
                       })
                  });
                const data = await response.json();
                 if (response.ok && data.replies && data.replies.length > 0) {
                     const botReplyDiv = document.createElement("div");
                     botReplyDiv.textContent = "Bot: " + data.replies[0].content;
                      messagesDiv.appendChild(botReplyDiv);

                 } else {
                  console.error("Failed to fetch bot response:", data);
                  const errorDiv = document.createElement("div");
                   errorDiv.textContent = "Error from Bot";
                   messagesDiv.appendChild(errorDiv);
                  }
               } catch (error) {
                console.error("Error sending message:", error);
             }


        }
    </script>
</body>
</html>
